---
title: "Fruit Model"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Running The Model

To run the model, run the file 'Fruit_model_run_with_my_data' in folder 'Run'. The parameters can be adjusted in the file 'Parameters' in folder 'Run'. The other scripts and functions involved are found in 'Analysis/Functions', 'Data/Data_Functions', 'Data/Data_Producer' and 'Model/Fruit_model'.

## Initialise

'Data_Functions.R' contains functions 'labeller', 'Data_in_final_form'. These are used to import the images we use to train or test our model. They produce

'params.R' contains the parameters we will need. These are then put into a list and called using params$parameter_name.

'Functions.R' contains functions 'image_tester', 'preds', 'multipreds', 'image_predictor'.

'Data_Producer.R' is slow to run.

'Fruit_model.R' needs parameters, contains function 'create_fruit_model'.

```{r results='hide'}
source('~/GitHub/NIAB_Rotation/Fruit_model/Data/Data_Functions.R')
source('~/GitHub/NIAB_Rotation/Fruit_model/Run/params.R')
source('~/GitHub/NIAB_Rotation/Fruit_model/Analysis/Functions.R') 
source('~/GitHub/NIAB_Rotation/Fruit_model/Model/Fruit_model.R')
```

```{r, echo=FALSE}
evaluate_scripts <- FALSE
evaluate_scripts2<- FALSE
```

```{r, eval=evaluate_scripts}
source('~/GitHub/NIAB_Rotation/Fruit_model/Data/Data_Producer.R')
```

Data_Functions will use:

```{r eval=FALSE}
library(abind)
library(OpenImageR)
library(dplyr)
```

params will use:

```{r eval=FALSE}
library(dplyr)
```

Fruit_model will use:

``` {r eval=FALSE}
library(keras)
library(dplyr)
library(ggplot2)
library(purrr)
```

Data_Producer will use:

```{r eval=FALSE}
library(reticulate)
```

And Fruit_model_run_with_my_data will use

```{r eval=FALSE}
library(keras)
library(dplyr)
library(ggplot2)
library(tidyr)
```

We can load the data files previously saved by script 'Data_producer'.

```{r}
Train_data_saved   <- readRDS("fruit_train_data.Rda")
Train_labels_saved <- readRDS("fruit_train_labels.Rda")
Test_data_saved    <- readRDS("fruit_test_data.Rda")
Test_labels_saved  <- readRDS("fruit_test_labels.Rda")
```


The model is set up to identify single fruits - it has not been trained on images with multiple fruits and the probabilities it gives sum to 1 for prediciting individual fruits.


## Comparison Between Colour Choices

### Model, Channel R

#### Fit Model, Channel R

Our data comes in from script 'Data_Producer'. Now we fit the model.

```{r}
params$channel_no = 1
```

```{r, eval=evaluate_scripts}
model_my_own <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels)
model_my_own %>% summary()
model_my_own %>% save_model_hdf5("fruit_model_r.h5")
```

#### Load Saved Model

We load saved models by using the code below.

```{r}
model_r <- load_model_hdf5("fruit_model_r.h5")
model_r %>% summary()
```

#### Test Model, Channel R

```{r}
results_r <- model_r %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

#### Obtain Predictions For Model, Channel R

```{r}
data <- image_tester(internet_path,"Banana")
```

```{r}
res_r <- model_r %>% predict(data)
preds(res_r)
mpreds_r<-multipreds(res_r,number_probs)
```
```{r echo=FALSE}
knitr::kable(mpreds_r, caption = "Table Of Predictions R")
```



### Model, Channel G

#### Fit Model, Channel G

```{r}
params$channel_no = 2
```

```{r results='hide', echo=FALSE, eval=evaluate_scripts}
model_g <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels_saved)
model_g %>% summary()
model_g %>% save_model_hdf5("fruit_model_g.h5")
```

```{r}
model_g <- load_model_hdf5("fruit_model_g.h5")
model_g %>% summary()
```


<!-- #### Test Model, Channel G -->

```{r results='hide', echo=FALSE}
results_g <- model_g %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

<!-- #### Obtain Predictions For Model, Channel G -->

```{r results='hide', echo=FALSE}
res_g <- model_g %>% predict(data)
preds(res_g)
mpreds_g<-multipreds(res_g,number_probs)
```

```{r echo=FALSE}
knitr::kable(mpreds_g, caption = "Table Of Predictions G")
```



### Model, Channel B

#### Fit Model, Channel B

```{r}
params$channel = 3
```

```{r results='hide', echo=FALSE, eval=evaluate_scripts}
model_b <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels_saved)
model_b %>% summary()
model_b %>% save_model_hdf5("fruit_model_b.h5")
```

```{r}
model_b <- load_model_hdf5("fruit_model_b.h5")
model_b %>% summary()
```


<!-- #### Test Model, Channel B -->

```{r results='hide', echo=FALSE}
results_b <- model_b %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

<!-- #### Obtain Predictions For Model, Channel B -->

```{r results='hide', echo=FALSE}
res_b <- model_b %>% predict(data)
preds(res_b)
mpreds_b<-multipreds(res_b,number_probs)
```

```{r echo=FALSE}
knitr::kable(mpreds_b, caption = "Table Of Predictions B")
```


### Model, Channels RG

```{r}
params$channel_no  = 1:2
```

#### Fit Model, Channels RG

```{r results='hide', echo=FALSE, eval=evaluate_scripts}
model_rg <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels_saved)
model_rg %>% summary()
model_rg %>% save_model_hdf5("fruit_model_rg.h5")
```

```{r}
model_rg <- load_model_hdf5("fruit_model_rg.h5")
model_rg %>% summary()
```

<!-- #### Test Model, Channels RG -->

```{r results='hide', echo=FALSE}
results_rg <- model_rg %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

<!-- #### Obtain Predictions For Model, Channels RG -->

```{r results='hide', echo=FALSE}
data <- image_tester(internet_path,"Banana")
```

```{r results='hide', echo=FALSE}
res_rg <- model_rg %>% predict(data)
preds(res_rg)
mpreds_rg<-multipreds(res_rg,number_probs)
```

```{r echo=FALSE}
knitr::kable(mpreds_rg, caption = "Table Of Predictions RG")
```


### Model, Channels RGB

```{r}
params$channel_no  = 1:3
```

#### Fit Model, Channels RGB


```{r results='hide', echo=FALSE, eval=evaluate_scripts}
model_rgb <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels_saved)
model_rgb %>% summary()
model_rgb %>% save_model_hdf5("fruit_model_rgb.h5")
```

```{r}
model_rgb <- load_model_hdf5("fruit_model_rgb.h5")
model_rgb %>% summary()
```

<!-- #### Test Model, Channels RGB -->

```{r results='hide', echo=FALSE}
results_rgb <- model_rgb %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

<!-- #### Obtain Predictions For Model, Channels RGB -->

```{r results='hide', echo=FALSE}
data <- image_tester(internet_path,"Banana")
```

```{r results='hide', echo=FALSE}
res_rgb <- model_rgb %>% predict(data)
preds(res_rgb)
mpreds_rgb<-multipreds(res_rgb,number_probs)
```

```{r echo=FALSE}
knitr::kable(mpreds_rgb, caption = "Table Of Predictions RGB")
```


## Summary

```{r echo=FALSE}
frame<-as.data.frame(results_r)
frame<-rbind(frame,as.data.frame(results_g),as.data.frame(results_b),as.data.frame(results_rg),as.data.frame(results_rgb))
colnames(frame)<-c("Loss","Accuracy")
frame$Model<-c("R only","G only","B only","RG","RGB")
frame<-frame[c("Model","Loss","Accuracy")]
```

```{r echo=FALSE}
knitr::kable(frame, caption = "Summary")
```



## Comparison of Image Sizes

### 100 x 100

```{r results='hide', eval=evaluate_scripts2}
params$xshape <- 100
params$yshape <- 100
params$train_data_name  <- "fruit_train_data100.Rda"
params$train_label_name <- "fruit_train_labels100.Rda"
params$test_data_name   <- "fruit_test_data100.Rda"
params$test_label_name  <- "fruit_test_labels100.Rda"


###

Train_data_and_labels <- Data_in_final_form(params$pathname,params$training_folder,params$labels_to_be_tested,params$filetype)

Train_data <-Train_data_and_labels$Image_array
Train_data <- aperm(Train_data,c(3,1,2)) # reorders elements
Train_labels <- Train_data_and_labels$label_vector[,1]
Train_total  <- length(Train_labels)
####

Test_data_and_labels <- Data_in_final_form(params$pathname,params$test_folder,params$labels_to_be_tested,params$filetype)

Test_data <-Test_data_and_labels$Image_array
Test_data <- aperm(Test_data,c(3,1,2)) # reorders elements
Test_labels <- Test_data_and_labels$label_vector[,1]
Test_total  <- length(Test_labels)

############################################

Train_data_reshaped <- array_reshape(Train_data,c(Train_total,params$xshape,params$yshape,3),order=c("F"))
Test_data_reshaped  <- array_reshape(Test_data,c(Test_total,params$xshape,params$yshape,3),order=c("F"))

saveRDS(Train_data_reshaped,file=params$train_data_name)
saveRDS(Train_labels,file=params$train_label_name)
saveRDS(Test_data_reshaped,file=params$test_data_name)
saveRDS(Test_labels,file=params$test_label_name)
```

```{r}
Train_data_saved <- readRDS("fruit_train_data100.Rda")
Train_labels_saved <- readRDS("fruit_train_labels100.Rda")
Test_data_saved <- readRDS("fruit_test_data100.Rda")
Test_labels_saved <- readRDS("fruit_test_labels100.Rda")
```

```{r results='hide', echo=FALSE, eval=evaluate_scripts2}
model_rgb100 <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels_saved) # drop = F stops R collapsing array to 3 dimensions not 4
model_rgb100 %>% summary()
model_rgb100 %>% save_model_hdf5("fruit_model_rgb100.h5")
```


```{r}
model_rgb100 <- load_model_hdf5("fruit_model_rgb100.h5")
model_rgb100 %>% summary()
```


```{r results='hide'}
results_rgb100 <- model_rgb100 %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

### 50 x 50

```{r echo=FALSE, results='hide', eval=evaluate_scripts2}
params$xshape <- 50
params$yshape <- 50
params$train_data_name  <- "fruit_train_data50.Rda"
params$train_label_name <- "fruit_train_labels50.Rda"
params$test_data_name   <- "fruit_test_data50.Rda"
params$test_label_name  <- "fruit_test_labels50.Rda"


###

Train_data_and_labels <- Data_in_final_form(params$pathname,params$training_folder,params$labels_to_be_tested,params$filetype)

Train_data <-Train_data_and_labels$Image_array
Train_data <- aperm(Train_data,c(3,1,2)) # reorders elements
Train_labels <- Train_data_and_labels$label_vector[,1]
Train_total  <- length(Train_labels)
####

Test_data_and_labels <- Data_in_final_form(params$pathname,params$test_folder,params$labels_to_be_tested,params$filetype)

Test_data <-Test_data_and_labels$Image_array
Test_data <- aperm(Test_data,c(3,1,2)) # reorders elements
Test_labels <- Test_data_and_labels$label_vector[,1]
Test_total  <- length(Test_labels)

############################################

Train_data_reshaped <- array_reshape(Train_data,c(Train_total,params$xshape,params$yshape,3),order=c("F"))
Test_data_reshaped  <- array_reshape(Test_data,c(Test_total,params$xshape,params$yshape,3),order=c("F"))

saveRDS(Train_data_reshaped,file=params$train_data_name)
saveRDS(Train_labels,file=params$train_label_name)
saveRDS(Test_data_reshaped,file=params$test_data_name)
saveRDS(Test_labels,file=params$test_label_name)
```

```{r, echo=FALSE}
Train_data_saved   <- readRDS("fruit_train_data50.Rda")
Train_labels_saved <- readRDS("fruit_train_labels50.Rda")
Test_data_saved    <- readRDS("fruit_test_data50.Rda")
Test_labels_saved  <- readRDS("fruit_test_labels50.Rda")
```

```{r results='hide', echo=FALSE, eval=evaluate_scripts2}
model_rgb50 <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels_saved) # drop = F stops R collapsing array to 3 dimensions not 4
model_rgb50 %>% summary()
model_rgb50 %>% save_model_hdf5("fruit_model_rgb50.h5")
```

```{r}
model_rgb50 <- load_model_hdf5("fruit_model_rgb50.h5")
model_rgb50 %>% summary()
```


```{r results='hide', echo=FALSE}
results_rgb50 <- model_rgb50 %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

### 28 x 28

```{r echo=FALSE, results='hide', eval=evaluate_scripts2}
params$xshape <- 28
params$yshape <- 28
params$train_data_name  <- "fruit_train_data28.Rda"
params$train_label_name <- "fruit_train_labels28.Rda"
params$test_data_name   <- "fruit_test_data28.Rda"
params$test_label_name  <- "fruit_test_labels28.Rda"


###

Train_data_and_labels <- Data_in_final_form(params$pathname,params$training_folder,params$labels_to_be_tested,params$filetype)

Train_data <-Train_data_and_labels$Image_array
Train_data <- aperm(Train_data,c(3,1,2)) # reorders elements
Train_labels <- Train_data_and_labels$label_vector[,1]
Train_total  <- length(Train_labels)
####

Test_data_and_labels <- Data_in_final_form(params$pathname,params$test_folder,params$labels_to_be_tested,params$filetype)

Test_data <-Test_data_and_labels$Image_array
Test_data <- aperm(Test_data,c(3,1,2)) # reorders elements
Test_labels <- Test_data_and_labels$label_vector[,1]
Test_total  <- length(Test_labels)

############################################

Train_data_reshaped <- array_reshape(Train_data,c(Train_total,params$xshape,params$yshape,3),order=c("F"))
Test_data_reshaped  <- array_reshape(Test_data,c(Test_total,params$xshape,params$yshape,3),order=c("F"))

saveRDS(Train_data_reshaped,file=params$train_data_name)
saveRDS(Train_labels,file=params$train_label_name)
saveRDS(Test_data_reshaped,file=params$test_data_name)
saveRDS(Test_labels,file=params$test_label_name)
```

```{r, echo=FALSE}
Train_data_saved   <- readRDS("fruit_train_data28.Rda")
Train_labels_saved <- readRDS("fruit_train_labels28.Rda")
Test_data_saved    <- readRDS("fruit_test_data28.Rda")
Test_labels_saved  <- readRDS("fruit_test_labels28.Rda")
```

```{r results='hide', echo=FALSE, eval=evaluate_scripts2}
model_rgb28 <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels_saved) # drop = F stops R collapsing array to 3 dimensions not 4
model_rgb28 %>% summary()
model_rgb28 %>% save_model_hdf5("fruit_model_rgb28.h5")
```


```{r}
model_rgb28 <- load_model_hdf5("fruit_model_rgb28.h5")
model_rgb28 %>% summary()
```


```{r results='hide', echo=FALSE}
results_rgb28 <- model_rgb28 %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

### 12 x 12

```{r echo=FALSE, results='hide', eval=evaluate_scripts2}
params$xshape <- 12
params$yshape <- 12
params$train_data_name  <- "fruit_train_data12.Rda"
params$train_label_name <- "fruit_train_labels12.Rda"
params$test_data_name   <- "fruit_test_data12.Rda"
params$test_label_name  <- "fruit_test_labels12.Rda"


###

Train_data_and_labels <- Data_in_final_form(params$pathname,params$training_folder,params$labels_to_be_tested,params$filetype)

Train_data <-Train_data_and_labels$Image_array
Train_data <- aperm(Train_data,c(3,1,2)) # reorders elements
Train_labels <- Train_data_and_labels$label_vector[,1]
Train_total  <- length(Train_labels)
####

Test_data_and_labels <- Data_in_final_form(params$pathname,params$test_folder,params$labels_to_be_tested,params$filetype)

Test_data <-Test_data_and_labels$Image_array
Test_data <- aperm(Test_data,c(3,1,2)) # reorders elements
Test_labels <- Test_data_and_labels$label_vector[,1]
Test_total  <- length(Test_labels)

############################################

Train_data_reshaped <- array_reshape(Train_data,c(Train_total,params$xshape,params$yshape,3),order=c("F"))
Test_data_reshaped  <- array_reshape(Test_data,c(Test_total,params$xshape,params$yshape,3),order=c("F"))

saveRDS(Train_data_reshaped,file=params$train_data_name)
saveRDS(Train_labels,file=params$train_label_name)
saveRDS(Test_data_reshaped,file=params$test_data_name)
saveRDS(Test_labels,file=params$test_label_name)
```

```{r, echo=FALSE}
Train_data_saved   <- readRDS("fruit_train_data12.Rda")
Train_labels_saved <- readRDS("fruit_train_labels12.Rda")
Test_data_saved    <- readRDS("fruit_test_data12.Rda")
Test_labels_saved  <- readRDS("fruit_test_labels12.Rda")
```

```{r results='hide', echo=FALSE, eval=evaluate_scripts2}
model_rgb12 <-create_fruit_model(Train_data_saved[,,,params$channel_no,drop = F],Train_labels_saved,Test_data_saved[,,,params$channel_no,drop = F],Test_labels_saved) # drop = F stops R collapsing array to 3 dimensions not 4
model_rgb12 %>% summary()
model_rgb12 %>% save_model_hdf5("fruit_model_rgb12.h5")
```


```{r}
model_rgb12 <- load_model_hdf5("fruit_model_rgb12.h5")
model_rgb12 %>% summary()
```


```{r results='hide', echo=FALSE}
results_rgb12 <- model_rgb12 %>% evaluate(Test_data_saved[,,,params$channel_no,drop=F], Test_labels_saved)
```

## Summary

```{r echo=FALSE}
frame<-as.data.frame(results_rgb100)
frame<-rbind(frame,as.data.frame(results_rgb50),as.data.frame(results_rgb28),as.data.frame(results_rgb12))
colnames(frame)<-c("Loss","Accuracy")
frame$Image_Size<-c("100","50","28","12")
frame<-frame[c("Image_Size","Loss","Accuracy")]
colnames(frame)<-c("Image_Size" ,"Loss","Accuracy")
```

```{r echo=FALSE}
knitr::kable(frame, caption = "RGB model, different image sizes")
```